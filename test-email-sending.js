#!/usr/bin/env node

/**
 * Email Sending Test Script
 * 
 * This script tests your email configuration to diagnose why emails aren't being received.
 * 
 * Usage:
 *   node test-email-sending.js YOUR_EMAIL@gmail.com
 */

// Load environment variables from .env.local
const fs = require('fs');
const path = require('path');

function loadEnv() {
  try {
    const envPath = path.join(__dirname, '.env.local');
    const envContent = fs.readFileSync(envPath, 'utf8');
    
    envContent.split('\n').forEach(line => {
      line = line.trim();
      if (line && !line.startsWith('#')) {
        const [key, ...valueParts] = line.split('=');
        const value = valueParts.join('=');
        if (key && value) {
          process.env[key.trim()] = value.trim();
        }
      }
    });
  } catch (error) {
    console.error('âš ï¸  Could not load .env.local file');
  }
}

loadEnv();

const { Resend } = require('resend');

const testEmail = process.argv[2];

if (!testEmail) {
  console.error('âŒ Please provide your email address:');
  console.error('   node test-email-sending.js your-email@gmail.com');
  process.exit(1);
}

console.log('ğŸ” Email Configuration Test\n');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

// Check environment variables
console.log('ğŸ“‹ Step 1: Checking Environment Variables\n');

const resendKey = process.env.RESEND_API_KEY;
const fromAddress = process.env.EMAIL_FROM_ADDRESS || 'onboarding@resend.dev';
const fromName = process.env.EMAIL_FROM_NAME || 'MarketingPro';
const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';

console.log(`   RESEND_API_KEY: ${resendKey ? 'âœ… Set (' + resendKey.substring(0, 10) + '...)' : 'âŒ Not set'}`);
console.log(`   EMAIL_FROM_ADDRESS: ${fromAddress}`);
console.log(`   EMAIL_FROM_NAME: ${fromName}`);
console.log(`   NEXT_PUBLIC_APP_URL: ${appUrl}`);
console.log('');

if (!resendKey || resendKey.includes('your_resend_api_key')) {
  console.error('âŒ RESEND_API_KEY is not configured properly!');
  console.error('');
  console.error('To fix:');
  console.error('1. Go to: https://resend.com/api-keys');
  console.error('2. Create a new API key');
  console.error('3. Update .env.local with: RESEND_API_KEY=re_YOUR_KEY_HERE');
  console.error('4. Restart your app');
  process.exit(1);
}

// Test Resend API
console.log('ğŸ“§ Step 2: Testing Resend API\n');

const resend = new Resend(resendKey);

async function testResendAPI() {
  try {
    console.log(`   Sending test email to: ${testEmail}`);
    console.log(`   From: ${fromName} <${fromAddress}>`);
    console.log('');

    const { data, error } = await resend.emails.send({
      from: `${fromName} <${fromAddress}>`,
      to: [testEmail],
      subject: 'ğŸ§ª Test Email - MarketingPro Email Verification',
      html: `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Test Email</title>
        </head>
        <body style="font-family: Arial, sans-serif; padding: 40px; background-color: #f5f5f5;">
          <div style="max-width: 600px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h1 style="color: #16a085; margin: 0 0 20px 0;">âœ… Email Test Successful!</h1>
            
            <p style="font-size: 16px; line-height: 1.6; color: #333;">
              If you're reading this, your email configuration is working correctly!
            </p>
            
            <div style="background: #f0f9ff; border-left: 4px solid #16a085; padding: 16px; margin: 20px 0;">
              <p style="margin: 0; font-size: 14px; color: #555;">
                <strong>Test Details:</strong><br>
                Sent from: ${fromName} &lt;${fromAddress}&gt;<br>
                Sent to: ${testEmail}<br>
                Time: ${new Date().toLocaleString()}
              </p>
            </div>
            
            <h2 style="color: #333; font-size: 18px; margin: 30px 0 15px 0;">Next Steps:</h2>
            
            <ol style="font-size: 14px; line-height: 1.8; color: #555;">
              <li>Check your inbox for this email</li>
              <li>If not in inbox, check spam/junk folder</li>
              <li>Mark as "Not Spam" if found in spam</li>
              <li>Add ${fromAddress} to your contacts</li>
              <li>Try registering a user in your app</li>
            </ol>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
              <p style="font-size: 12px; color: #999; margin: 0;">
                This is a test email from MarketingPro Email Verification System<br>
                Generated by: test-email-sending.js
              </p>
            </div>
          </div>
        </body>
        </html>
      `,
    });

    if (error) {
      console.error('   âŒ Resend API Error:', error);
      console.error('');
      console.error('Common issues:');
      console.error('- Invalid API key');
      console.error('- API key expired or revoked');
      console.error('- Domain not verified (for custom domains)');
      console.error('- Rate limit exceeded');
      console.error('');
      console.error('To fix:');
      console.error('1. Go to: https://resend.com/api-keys');
      console.error('2. Verify your API key is active');
      console.error('3. Create a new key if needed');
      console.error('4. Update .env.local');
      return false;
    }

    console.log('   âœ… Email sent successfully!');
    console.log('');
    console.log('   Email ID:', data.id);
    console.log('');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    console.log('âœ… SUCCESS! Email Configuration is Working\n');
    console.log('Next steps:');
    console.log('1. Check your inbox: ' + testEmail);
    console.log('2. If not there, check spam/junk folder');
    console.log('3. Look for email from: ' + fromAddress);
    console.log('4. Subject: "ğŸ§ª Test Email - MarketingPro Email Verification"');
    console.log('');
    console.log('If you received the email:');
    console.log('âœ… Your email system is working!');
    console.log('âœ… Registration emails should work too');
    console.log('');
    console.log('If you didn\'t receive it:');
    console.log('- Wait 1-2 minutes (email delivery can be slow)');
    console.log('- Check spam folder thoroughly');
    console.log('- Try a different email address');
    console.log('- Check Resend dashboard: https://resend.com/emails');
    console.log('');
    console.log('To view email status:');
    console.log('https://resend.com/emails/' + data.id);
    console.log('');
    
    return true;
  } catch (error) {
    console.error('   âŒ Unexpected Error:', error.message);
    console.error('');
    console.error('Stack trace:', error.stack);
    return false;
  }
}

// Run the test
testResendAPI().then(success => {
  if (!success) {
    console.log('');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    console.log('âŒ Email Test Failed\n');
    console.log('Please check the errors above and try again.');
    console.log('');
    console.log('Need help? Check:');
    console.log('- TROUBLESHOOT_EMAIL_NOT_RECEIVED.md');
    console.log('- https://resend.com/docs');
    console.log('');
    process.exit(1);
  }
}).catch(error => {
  console.error('âŒ Fatal Error:', error);
  process.exit(1);
});
